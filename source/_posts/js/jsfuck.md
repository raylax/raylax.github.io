---
title: js源码分析之jsfuck
date: 2021-01-22 21:33:43
categories:
	- js/es/ts
tags:
	- js
---

# 简述
`jsfuck`可以将`js`代码转换成以`[]()!+`六个字符组成的可执行代码
例如`alert(1)`可以转换成`(![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]+(!![]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[+!+[]+[!+[]+!+[]+!+[]]]+[+!+[]]+([+[]]+![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[!+[]+!+[]+[+[]]]`

# 原理
本质上基于`js`的类型转换
1. 数组 => booleal
因为数组是真值<sup>1</sup>所以使用`!`将数组转换成`boolean`类型为`false`

2. 数组 => 数字 +[N]
当**数组长度为0**或者**长度为1且N为空字符串**，例如`+[]、+['']`，`+[N]`的值为`0`
当**数组长度为1且N为数字是**，例如`+[2]、+['9']`，`+[N]`的值为`N`
当**数组长度大于0**或**数组第一个元素不是上述两种情况**，例如`+[1,2,3]、+[false]`，`+[N]`的值为`NaN`

3. boolean => 数字
`true/false`转换为数字分别为`1`和`0`



## 转换
```javascript
false       =  ![]
true        =  !![]
undefined   =  [][[]] // [][0] = undefined
NaN         =  +[![]] // +[false] = NaN
0           =  +[] // 0
1           =  +!+[] // +!+0 = +!0 = +true = 1
2           =  !+[]+!+[] // !+[] + !+[] = !0 + !0 = true + true = 2
10          =  +[[+!+[]]+[+[]]] // +[[1]+[0]] = +['10'] = 10
Array       =  []
Number      =  +[] // 0
String      =  []+[] // "" + "" = ""
Boolean     =  ![] // false
Function    =  []["filter"] // 数组的filter方法
run         =  []["filter"]["constructor"]( CODE )() // 执行CODE
eval        =  []["filter"]["constructor"]("return eval")()( CODE ) // eval CODE
window      =  []["filter"]["constructor"]("return this")() // 返回window对象
```

## 执行

### run
`[]["filter"]`会获取数组的`filter`方法，`[]["filter"]["constructor"]`会返回`filter`方法的构造函数，js中所有的方法的构造函数都是`Function`<sup>2</sup>对象
`Function`<sup>2</sup>的最后一个参数会被当做方法体执行所以`[]["filter"]["constructor"]( "console.log(1)" )()`会输出`1`

### eval & window
`Function`<sup>2</sup>执行的作用域是全局作用域所以`[]["filter"]["constructor"]("return this")()`对于浏览器来说返回`window`，同理`[]["filter"]["constructor"]("return eval")()( CODE )`相当于返回`return window.eval`然后传递`CODE`执行

> `[]["filter"]`中非只能是`filter`，理论上只要数组支持的函数都可以。
例如`map`，`push`，`pop`等都可以
这里使用`flat`、`filter`函数是因为其中的字母都可以从`true/false`里直接获取

## 解析
通过上面的分析我们就可以把代码替换成相应的`[]()!+`组合

例如官方示例`alert(1)`，可以拆解为`a`、`l`、`e`、`r`、`t`、`(`、`1`、`)`

字符串和数字替换比较简单

```javascript
a = (false+"")[1]				= (![]+([]+[]))[+!+[]]
l = (false+"")[2]				= (![]+([]+[]))[!+[]+!+[]]
e = (true+"")[3]				= (!![]+([]+[]))[!+[]+!+[]+!+[]]
r = (true+"")[1]				= (!![]+([]+[]))[+!+[]]
t = (true+"")[0]				= (!![]+([]+[]))[+[]]
1 = 						= +!+[]
```
括号等特殊字符需要从`function`的`toString`里获取，例如`"" + []["flat"]`返回`function flat() { [native code] }`，可以从中获取小括号大括号
第13个为小括号13可以通过拼接`!+[]`十三次实现，但是`"flat"`也需要替换
```javascript
// flat
f = (![]+([]+[]))[+[]]
l = (![]+([]+[]))[!+[]+!+[]]
a = (![]+([]+[]))[+!+[]]
t = (!![]+([]+[]))[+[]]
```
最终flat为`((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])`
括号
```javascript
( = ([]["flat"]+"")[13] = ([][(![]+([]+[]))[+[]]+(![]+([]+[]))[!+[]+!+[]]+(![]+([]+[]))[+!+[]]+(!![]+([]+[]))[+[]]]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]
) = ([]["flat"]+"")[14]	= ([][(![]+([]+[]))[+[]]+(![]+([]+[]))[!+[]+!+[]]+(![]+([]+[]))[+!+[]]+(!![]+([]+[]))[+[]]]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]
```
组合起来`alert(1)`为`((![]+([]+[]))[+!+[]])+((![]+([]+[]))[!+[]+!+[]])+((!![]+([]+[]))[!+[]+!+[]+!+[]])+((!![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])+(([][(![]+([]+[]))[+[]]+(![]+([]+[]))[!+[]+!+[]]+(![]+([]+[]))[+!+[]]+(!![]+([]+[]))[+[]]]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])+(+!+[])+(([][(![]+([]+[]))[+[]]+(![]+([]+[]))[!+[]+!+[]]+(![]+([]+[]))[+!+[]]+(!![]+([]+[]))[+[]]]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])`
我们还需要利用上面讲到的`[]["flat"]["constructor"]( CODE )()`让他运行起来
需要替换`flat`和`constructor`，其中很多字符已经转换过了，只需转换`c`，`o`，`n`，`s`，`u`

```javascript
c = ([]["flat"]+"")[3]
o = ([]["flat"]+"")[27]
n = ([]["flat"]+"")[19]
s = (false+"")[3]		= (![]+([]+[]))[!+[]+!+[]+!+[]]
u = (true+"")[2] 		= (!![]+([]+[]))[!+[]+!+[]]
```
constructor为
`(([]["flat"]+"")[3])+(([]["flat"]+"")[27])+(([]["flat"]+"")[19])+((false+"")[3])+((!![]+([]+[]))[+[]])+((!![]+([]+[]))[+!+[]])+((!![]+([]+[]))[!+[]+!+[]])+(([]["flat"]+"")[3])+((!![]+([]+[]))[+[]])+(([]["flat"]+"")[27])+((!![]+([]+[]))[+!+[]])`
替换`true/false/flat`和数字
`(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]])+(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])+(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])+((![]+([]+[]))[!+[]+!+[]+!+[]])+((!![]+([]+[]))[+[]])+((!![]+([]+[]))[+!+[]])+((!![]+([]+[]))[!+[]+!+[]])+(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]])+((!![]+([]+[]))[+[]])+(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])+((!![]+([]+[]))[+!+[]])`

最终可执行代码为
```javascript
[][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])][(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]])+(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])+(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])+((![]+([]+[]))[!+[]+!+[]+!+[]])+((!![]+([]+[]))[+[]])+((!![]+([]+[]))[+!+[]])+((!![]+([]+[]))[!+[]+!+[]])+(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]])+((!![]+([]+[]))[+[]])+(([][((![]+([]+[]))[+[]])+((![]+([]+[]))[!+[]+!+[]])+((![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])+((!![]+([]+[]))[+!+[]])](((![]+([]+[]))[+!+[]])+((![]+([]+[]))[!+[]+!+[]])+((!![]+([]+[]))[!+[]+!+[]+!+[]])+((!![]+([]+[]))[+!+[]])+((!![]+([]+[]))[+[]])+(([][(![]+([]+[]))[+[]]+(![]+([]+[]))[!+[]+!+[]]+(![]+([]+[]))[+!+[]]+(!![]+([]+[]))[+[]]]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]])+(+!+[])+(([][(![]+([]+[]))[+[]]+(![]+([]+[]))[!+[]+!+[]]+(![]+([]+[]))[+!+[]]+(!![]+([]+[]))[+[]]]+([]+[]))[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]))()
```


# 参考
- [1] [MDN 真值](https://developer.mozilla.org/zh-CN/docs/Glossary/Truthy)
- [2] [MDN Function](https://developer.mozilla.org/zh-cn/docs/web/javascript/reference/global_objects/function)
- [3] [jsfuck](https://github.com/aemkei/jsfuck)